<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scout Room 24 - Social</title>
    <style>
        /* --- CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --- */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #fafafa; margin: 0; padding-bottom: 90px; color: #262626; }
        header { background: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dbdbdb; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 16px; margin: 0; color: #5d4037; font-weight: 800; }
        .user-name-display { font-size: 12px; color: #0095f6; cursor: pointer; font-weight: bold; background: #f0f9ff; padding: 5px 10px; border-radius: 15px; }
        #feed { width: 100%; max-width: 500px; margin: 0 auto; }
        .post { background: #fff; border-bottom: 1px solid #efefef; margin-bottom: 10px; position: relative; }
        .post-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .post-user { font-weight: 600; font-size: 14px; display: flex; align-items: center; }
        .post-user::before { content: ""; width: 25px; height: 25px; background: #ddd; border-radius: 50%; margin-right: 8px; display: inline-block; }
        .post-menu { cursor: pointer; color: #999; padding: 5px; font-weight: bold; }
        .post img { width: 100%; display: block; background: #f0f0f0; }
        .post-actions { padding: 10px 12px; display: flex; gap: 15px; }
        .action-btn { cursor: pointer; font-size: 22px; background: none; border: none; padding: 0; transition: transform 0.1s; }
        .action-btn:active { transform: scale(1.2); }
        .like-count { font-size: 14px; font-weight: 700; padding: 0 12px; margin-bottom: 5px; }
        .post-content { padding: 0 12px 10px; font-size: 14px; line-height: 1.4; }
        .comment-section { padding: 8px 12px; border-top: 1px solid #fafafa; font-size: 13px; background: #fcfcfc; }
        .comment-item { margin-bottom: 4px; }
        .comment-input-area { display: flex; padding: 10px 12px; border-top: 1px solid #efefef; }
        .comment-input { flex: 1; border: none; outline: none; font-size: 13px; background: transparent; }
        .btn-open-modal { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: #2e7d32; color: white; border-radius: 50%; border: none; font-size: 35px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); }
        .modal-content { background: white; width: 100%; position: absolute; bottom: 0; padding: 25px; border-radius: 20px 20px 0 0; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        textarea { width: 100%; height: 90px; margin: 10px 0; border: 1px solid #dbdbdb; border-radius: 10px; padding: 12px; font-size: 16px; resize: none; outline: none; }
        .btn-post { background: #0095f6; color: white; border: none; padding: 14px; border-radius: 10px; width: 100%; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-post:disabled { background: #b2dffc; }
    </style>
</head>
<body>

    <header>
        <h1>üèïÔ∏è SCOUT ROOM 24</h1>
        <div class="user-name-display" onclick="changeName()">üë§ <span id="currentUserName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></div>
    </header>

    <div id="feed">
        <p style="text-align:center; color:#999; margin-top:50px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÜ...</p>
    </div>

    <button class="btn-open-modal" onclick="openNewPostModal()">+</button>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top:0; text-align:center;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <div id="fileArea">
                <input type="file" id="imageInput" accept="image/*" style="margin-bottom:15px; width:100%;">
            </div>
            <textarea id="captionInput" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            <input type="hidden" id="editPostId">
            <button class="btn-post" id="postBtn" onclick="handlePostSubmit()">‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
            <button onclick="toggleModal('postModal', false)" style="margin-top:15px; border:none; background:none; color:#ed4956; width:100%; font-weight:bold; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQwpiCLNLu4DQrBawxvyYA62ATmAYYKRs",
            authDomain: "scoutroom24.firebaseapp.com",
            projectId: "scoutroom24",
            storageBucket: "scoutroom24.firebasestorage.app",
            messagingSenderId: "863717190356",
            appId: "1:863717190356:web:ad6bf171a7dff9d808e941"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        let myName = localStorage.getItem("scoutUserName");
        if (!myName) {
            myName = prompt("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:") || "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠";
            localStorage.setItem("scoutUserName", myName);
        }
        document.getElementById("currentUserName").innerText = myName;

        function changeName() {
            let newName = prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:", myName);
            if (newName && newName.trim() !== "") {
                myName = newName;
                localStorage.setItem("scoutUserName", myName);
                document.getElementById("currentUserName").innerText = myName;
            }
        }

        // --- 3. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
        }

        function openNewPostModal() {
            document.getElementById('editPostId').value = "";
            document.getElementById('captionInput').value = "";
            document.getElementById('imageInput').value = "";
            document.getElementById('modalTitle').innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà";
            document.getElementById('fileArea').style.display = "block";
            toggleModal('postModal', true);
        }

        // --- 4. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Feed (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            if (snapshot.empty) {
                feed.innerHTML = '<p style="text-align:center; color:#999; margin-top:50px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏•‡∏¢ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏¥!</p>';
                return;
            }
            snapshot.forEach((doc) => {
                const post = doc.data();
                const id = doc.id;
                const isMyPost = post.userName === myName;
                
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                postDiv.innerHTML = `
                    <div class="post-header">
                        <span class="post-user">${post.userName}</span>
                        ${isMyPost ? `<div class="post-menu" onclick="showOptions('${id}', '${post.caption}')">‚ãÆ</div>` : ''}
                    </div>
                    <img src="${post.imageUrl}" loading="lazy">
                    <div class="post-actions">
                        <button class="action-btn" onclick="likePost('${id}', ${post.likes || 0})">‚ù§Ô∏è</button>
                    </div>
                    <div class="like-count">${post.likes || 0} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</div>
                    <div class="post-content"><b>${post.userName}</b> ${post.caption || ''}</div>
                    <div class="comment-section">
                        ${(post.comments || []).map(c => `<div class="comment-item"><b>${c.user}</b> ${c.text}</div>`).join('')}
                    </div>
                    <div class="comment-input-area">
                        <input type="text" class="comment-input" id="input-${id}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå...">
                        <button style="border:none; background:none; color:#0095f6; font-weight:bold; cursor:pointer;" onclick="addComment('${id}')">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                    </div>
                `;
                feed.appendChild(postDiv);
            });
        });

        // --- 5. ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ä‡πâ Vercel Blob) ---
        async function handlePostSubmit() {
            const editId = document.getElementById('editPostId').value;
            const caption = document.getElementById('captionInput').value;
            const btn = document.getElementById('postBtn');

            if (editId) {
                await db.collection("posts").doc(editId).update({ caption: caption });
                toggleModal('postModal', false);
            } else {
                const fileInput = document.getElementById('imageInput');
                const file = fileInput.files[0];
                if (!file) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");

                btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
                btn.disabled = true;

                try {
                    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å ImgBB ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á‡∏ö‡∏ô Vercel
                    const response = await fetch(`/api/upload?filename=${encodeURIComponent(file.name)}`, {
                        method: 'POST',
                        body: file,
                    });

                    if(!response.ok) throw new Error("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á Vercel ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    
                    const result = await response.json();
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firebase Firestore ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                    await db.collection("posts").add({
                        imageUrl: result.url, // URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Vercel Blob
                        caption: caption,
                        userName: myName,
                        likes: 0,
                        comments: [],
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    toggleModal('postModal', false);
                } catch (e) { 
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); 
                } finally {
                    btn.innerText = "‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå"; 
                    btn.disabled = false;
                }
            }
        }

        // --- 6. ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏•‡∏Ñ‡πå, ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç, ‡∏•‡∏ö (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        async function likePost(id, currentLikes) {
            await db.collection("posts").doc(id).update({ likes: currentLikes + 1 });
        }

        async function addComment(id) {
            const input = document.getElementById(`input-${id}`);
            if (!input.value.trim()) return;
            const commentObj = { user: myName, text: input.value };
            await db.collection("posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion(commentObj)
            });
            input.value = "";
        }

        function showOptions(id, currentCaption) {
            const action = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå 'edit' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ 'delete' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå:");
            if (action === 'delete') {
                if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    db.collection("posts").doc(id).delete();
                }
            } else if (action === 'edit') {
                document.getElementById('editPostId').value = id;
                document.getElementById('captionInput').value = currentCaption;
                document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå";
                document.getElementById('fileArea').style.display = "none";
                toggleModal('postModal', true);
            }
        }
    </script>
</body>
</html>
