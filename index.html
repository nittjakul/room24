// --- ส่วนการตั้งค่า Firebase (เอามาจากหน้าเว็บ Firebase ของคุณ) ---
const firebaseConfig = {
  apiKey: "AIzaSyDQwpiCLNLu4DQrBawxvyYA62ATmAYYKRs",
  authDomain: "scoutroom24.firebaseapp.com",
  projectId: "scoutroom24",
  storageBucket: "scoutroom24.firebasestorage.app",
  messagingSenderId: "863717190356",
  appId: "1:863717190356:web:ad6bf171a7dff9d808e941",
  measurementId: "G-QNTS6Q643L"
};

// เริ่มใช้งาน Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// 1. ฟังก์ชันดึงข้อมูลจาก Database มาแสดง (เชื่อมต่อทุกคน)
db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
    const feed = document.getElementById('feed');
    feed.innerHTML = ""; // ล้างหน้าจอเพื่อโหลดใหม่
    snapshot.forEach((doc) => {
        const data = doc.data();
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        postDiv.innerHTML = `
            <div class="post-header"><div class="avatar"></div><span>ลูกเสือห้อง 24</span></div>
            <img src="${data.imageUrl}">
            <div class="post-content"><p class="post-caption"><b>เพื่อน</b> ${data.caption}</p></div>
        `;
        feed.appendChild(postDiv);
    });
});

// 2. ฟังก์ชันอัปโหลดรูปและบันทึกข้อมูล
async function addNewPost() {
    const fileInput = document.getElementById('imageInput');
    const captionInput = document.getElementById('captionInput');
    const file = fileInput.files[0];

    if (!file) return alert("กรุณาเลือกรูป!");

    // แสดงสถานะว่ากำลังโหลด
    const btn = document.querySelector('.btn-post');
    btn.innerText = "กำลังโพสต์...";
    btn.disabled = true;

    try {
        // อัปโหลดรูปไปที่ Firebase Storage
        const storageRef = storage.ref('photos/' + file.name);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();

        // บันทึกข้อความและลิงก์รูปลง Firestore
        await db.collection("posts").add({
            imageUrl: url,
            caption: captionInput.value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // ล้างค่าและปิดหน้าต่าง
        captionInput.value = '';
        fileInput.value = '';
        toggleModal(false);
    } catch (error) {
        alert("เกิดข้อผิดพลาด: " + error.message);
    } finally {
        btn.innerText = "แชร์โพสต์";
        btn.disabled = false;
    }
}
