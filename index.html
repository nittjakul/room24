<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scout Room 24 Plus</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background-color: #fafafa; margin: 0; padding-bottom: 90px; }
        header { background: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dbdbdb; position: sticky; top: 0; z-index: 100; }
        header h1 { font-size: 16px; margin: 0; color: #5d4037; }
        .user-name-display { font-size: 12px; color: #0095f6; cursor: pointer; font-weight: bold; }

        #feed { width: 100%; max-width: 500px; margin: 0 auto; }
        .post { background: #fff; border-bottom: 1px solid #efefef; margin-bottom: 10px; position: relative; }
        .post-header { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .post-user { font-weight: 600; font-size: 14px; }
        .post-menu { cursor: pointer; color: #999; }
        .post img { width: 100%; display: block; }
        
        .post-actions { padding: 10px; display: flex; gap: 15px; }
        .action-btn { cursor: pointer; font-size: 20px; background: none; border: none; padding: 0; }
        .like-count { font-size: 14px; font-weight: 600; padding: 0 10px; }
        
        .post-content { padding: 5px 10px 10px; font-size: 14px; }
        .comment-section { padding: 10px; border-top: 1px solid #fafafa; font-size: 13px; }
        .comment-input-area { display: flex; padding: 10px; border-top: 1px solid #efefef; }
        .comment-input { flex: 1; border: none; outline: none; font-size: 13px; }

        .btn-open-modal { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: #2e7d32; color: white; border-radius: 50%; border: none; font-size: 35px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: white; width: 100%; position: absolute; bottom: 0; padding: 25px; border-radius: 20px 20px 0 0; }
        textarea { width: 100%; height: 80px; margin: 10px 0; border: 1px solid #dbdbdb; border-radius: 8px; padding: 10px; }
        .btn-post { background: #0095f6; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>üå≤ SCOUT 24</h1>
        <div class="user-name-display" onclick="changeName()">üë§ <span id="currentUserName">Loading...</span></div>
    </header>

    <div id="feed"></div>

    <button class="btn-open-modal" onclick="toggleModal('postModal', true)">+</button>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <input type="file" id="imageInput" accept="image/*">
            <textarea id="captionInput" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô..."></textarea>
            <input type="hidden" id="editPostId">
            <button class="btn-post" id="postBtn" onclick="handlePostSubmit()">‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
            <button onclick="toggleModal('postModal', false)" style="margin-top:10px; border:none; background:none; color:red; width:100%;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQwpiCLNLu4DQrBawxvyYA62ATmAYYKRs",
            authDomain: "scoutroom24.firebaseapp.com",
            projectId: "scoutroom24",
            storageBucket: "scoutroom24.firebasestorage.app",
            messagingSenderId: "863717190356",
            appId: "1:863717190356:web:ad6bf171a7dff9d808e941"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠ ---
        let myName = localStorage.getItem("scoutUserName");
        if (!myName) {
            myName = prompt("‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:") || "‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠‡πÑ‡∏£‡πâ‡∏ô‡∏≤‡∏°";
            localStorage.setItem("scoutUserName", myName);
        }
        document.getElementById("currentUserName").innerText = myName;

        function changeName() {
            let newName = prompt("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:", myName);
            if (newName) {
                myName = newName;
                localStorage.setItem("scoutUserName", myName);
                document.getElementById("currentUserName").innerText = myName;
            }
        }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'block' : 'none';
            if (!show) { // Reset values
                document.getElementById('editPostId').value = "";
                document.getElementById('modalTitle').innerText = "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà";
                document.getElementById('imageInput').style.display = "block";
            }
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Feed ---
        db.collection("posts").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snapshot.forEach((doc) => {
                const post = doc.data();
                const id = doc.id;
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÑ‡∏´‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö)
                const isMyPost = post.userName === myName;
                const menuHtml = isMyPost ? `
                    <div class="post-menu" onclick="showPostOptions('${id}', '${post.caption}')">‚ãÆ</div>
                ` : '';

                postDiv.innerHTML = `
                    <div class="post-header">
                        <span class="post-user">${post.userName || '‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠ 24'}</span>
                        ${menuHtml}
                    </div>
                    <img src="${post.imageUrl}" loading="lazy">
                    <div class="post-actions">
                        <button class="action-btn" onclick="likePost('${id}', ${post.likes || 0})">‚ù§Ô∏è</button>
                    </div>
                    <div class="like-count">${post.likes || 0} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</div>
                    <div class="post-content"><b>${post.userName}</b> ${post.caption || ''}</div>
                    <div class="comment-section" id="comments-${id}">
                        ${(post.comments || []).map(c => `<div><b>${c.user}:</b> ${c.text}</div>`).join('')}
                    </div>
                    <div class="comment-input-area">
                        <input type="text" class="comment-input" id="input-${id}" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå...">
                        <button style="border:none; background:none; color:#0095f6; font-weight:bold;" onclick="addComment('${id}')">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
                    </div>
                `;
                feed.appendChild(postDiv);
            });
        });

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏û‡∏™‡∏ï‡πå ---
        async function handlePostSubmit() {
            const editId = document.getElementById('editPostId').value;
            const caption = document.getElementById('captionInput').value;
            
            if (editId) {
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå
                await db.collection("posts").doc(editId).update({ caption: caption });
                toggleModal('postModal', false);
            } else {
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                const fileInput = document.getElementById('imageInput');
                if (!fileInput.files[0]) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
                
                const btn = document.getElementById('postBtn');
                btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
                btn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append("image", fileInput.files[0]);
                    const res = await fetch('https://api.imgbb.com/1/upload?key=953b0a985d91136a7dca903586d3f298', { method: 'POST', body: formData });
                    const result = await res.json();
                    
                    if(result.success) {
                        await db.collection("posts").add({
                            imageUrl: result.data.url,
                            caption: caption,
                            userName: myName,
                            likes: 0,
                            comments: [],
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        toggleModal('postModal', false);
                    }
                } catch (e) { alert("Error: " + e.message); }
                btn.innerText = "‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏û‡∏™‡∏ï‡πå"; btn.disabled = false;
            }
        }

        function showPostOptions(id, currentCaption) {
            const action = prompt("‡∏û‡∏¥‡∏°‡∏û‡πå 'edit' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠ 'delete' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ô‡∏µ‡πâ:");
            if (action === 'delete') {
                if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå?")) db.collection("posts").doc(id).delete();
            } else if (action === 'edit') {
                document.getElementById('editPostId').value = id;
                document.getElementById('captionInput').value = currentCaption;
                document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô";
                document.getElementById('imageInput').style.display = "none";
                toggleModal('postModal', true);
            }
        }

        async function likePost(id, currentLikes) {
            await db.collection("posts").doc(id).update({ likes: currentLikes + 1 });
        }

        async function addComment(id) {
            const input = document.getElementById(`input-${id}`);
            if (!input.value) return;
            const commentObj = { user: myName, text: input.value };
            await db.collection("posts").doc(id).update({
                comments: firebase.firestore.FieldValue.arrayUnion(commentObj)
            });
            input.value = "";
        }
    </script>
</body>
</html>

